
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<title>Season Eleven</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Django e-booklet">
<meta name="keywords" content="django, django learning">
<meta name="author" content="Mahdi Rezaie, Ali Ebrahimian">
<link rel="icon" href="../Images/favicon.ico" type="image/ico">

<link rel="stylesheet" type="text/css" href="https://virapy.github.io/assets/CSS/seasons-style.css">
<link rel="stylesheet" type="text/css" href="https://virapy.github.io/assets/CSS/Footer-style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body>
<main>
    <div class="container">
        <div class="content">
            <h2>فصل یازدهم: اپلیکیشن فروشگاه اینترنتی (بخش دوم)</h2><div class="toc"><h3>فهرست مطالب</h3><ul>
<li><a href="#snrywy-tkhmyl-frynd-khryd">سناریوی تکمیل فرایند خرید</a></li>
<li><a href="#rsl-pymkh-b-wb-srwys-khwh-ngr">ارسال پیامک با وب سرویس (کاوه نگار)</a></li>
<li><a href="#pydh-szy-dryft-shmrh-khrbr">پیاده سازی دریافت شماره کاربر</a></li>
<li><a href="#rsl-w-brrsy-khd-tyyd-bh-shmrh-khrbr">ارسال و بررسی کد تایید به شماره کاربر</a></li>
<li><a href="#dryft-mshkhst-sfrsh-z-khrbr">دریافت مشخصات سفارش از کاربر</a></li>
<li><a href="#tsl-drgh-prdkht-zryn-pl-bh-frwshgh">اتصال درگاه پرداخت (زرین پال) به فروشگاه</a></li>
<li><a href="#sfht-wd-yt-prdkht-lyst-w-jzyyt-sfrsh">صفحات وضعیت پرداخت، لیست و جزئیات سفارش</a></li>
<li><a href="#qblyt-khrwjy-fyl-excel-z-sfrsh-h-dr-pnl-dmyn">قابلیت خروجی فایل Excel از سفارش ها در پنل ادمین</a></li>
<li><a href="#tmrynt-fsl-11-mhm">تمرینات فصل 11 (مهم)</a></li>
</ul></div>
<h3 id="snrywy-tkhmyl-frynd-khryd">سناریوی تکمیل فرایند خرید</h3>
<p><strong>این بخش از آموزش صرفا تئوری بوده و خبری از کد زدن نیست!</strong></p>
<p><strong>فرایند تکمیل خرید =&gt;</strong> کاربر سبد خرید را کامل کرده و روی ادامه خرید کلیک کرده؛ از اینجا سناریوی فرایند خرید شروع میشود:</p>
<p><strong>حالا دو حالت وجود دارد:</strong></p>
<p><strong>1-</strong> کاربر از قبل لاگین کرده است.  <br />
<strong>2-</strong> کاربر هنوز لاگین نکرده است.</p>
<ol>
<li>
<p><strong>اگر کاربر از قبل لاگین  کرده بود:</strong> وقتی ادامه خرید را انتخاب میکند چنانچه اطلاعات کاربر کامل باشد؛ به صفحه تایید خرید و درگاه پرداخت منتقل میشود. </p>
<p>اگر هم اطلاعات کامل نیست، ابتدا به صفحه تکمیل فرم اطلاعات و سپس به صفحه تایید خرید و درگاه پرداخت منتقل میشود.</p>
</li>
<li>
<p><strong>کاربر لاگین نکرده است:</strong> پس از انتخاب محصولات وقتی روی  ادامه خرید کلیک میکند از کاربر یک شماره تلفن برای تایید شخص درخواست میکند(یک کد برای شماره تلفن ارسال میشود.)؛ </p>
<p><strong>اگر شماره از قبل در دیتابیس وجود داشته باشد(حساب داشته باشد)</strong>؛ کاربر را به صفحه تایید خرید و درگاه پرداخت منتقل میکنیم.</p>
<p><strong>اگر شماره وجود نداشت</strong>؛ برای آن شخص با توجه به شماره تلفن یک حساب کاربری ایجاد میکنیم و سپس کاربر را به صفحه تایید خرید منتقل میکنیم.</p>
<ul>
<li>در یک فرم  مشخصات گیرنده سفارش را از کاربر دریافت میکنیم.</li>
</ul>
</li>
</ol>
<h3 id="rsl-pymkh-b-wb-srwys-khwh-ngr">ارسال پیامک با وب سرویس (کاوه نگار)</h3>
<p><strong>نکته:</strong> برای ارسال پیامک در <strong>وب سرویس های پیامکی</strong> لازم است که در آن وبسایت ها ثبت نام کرده و مراحل احراز هویت را تکمیل کنید.</p>
<p>برای ارسال کد تایید، اطلاع رسانی ها، وضعیت سفارش خریدار و... از سرویس پیامکی استفاده میکنیم.</p>
<p>در اینجا وب سرویس پیامکی کاوه نگار را معرفی میکنیم ولی شما میتوانید از وب سرویس های دیگری استفاده کنید؛ چون ساختار و نحوه استفاده تقریبا مشابه یکدیگر میباشد.</p>
<p><strong>1-</strong> در مرحله اول لازم است ثبت نام و احراز هویت را؛ که در وبسایت سرویس پیامکی انجام دهیم.</p>
<p><strong>2-</strong> در بخش <strong><em>حساب من</em></strong> یک API Key وجود دارد، که در کدها به آن نیاز داریم. / با کلیک روی آیکون کلید (🔑)  یک API جدید ایجاد میکند(API قبلی منقضی میشود.)</p>
<p><strong>پیامک های ارسالی دو حالت دارند:</strong></p>
<p>1- پیامک های کد تایید یا دارای یک کلمه خاص(پیامک های توکن دار)  <br />
2- پیامک عادی (شامل یک متن ساده)</p>
<p><strong>نکته:</strong> مدیریت و ساختار پیامک های توکن دار در بخش اعتبارسنجی سرویس پیامکی (کاوه نگار) انجام میشود.</p>
<p><a href="https://res.cloudinary.com/am-er/image/upload/v1724505875/kavenegar-client-Verification_ewem5f.png"><img alt="verification-SMS" src="https://res.cloudinary.com/am-er/image/upload/v1724505875/kavenegar-client-Verification_ewem5f.png" / class="edu-img"></a></p>
<p><strong>توضیحات:</strong></p>
<p>1- از بخش <strong>تعریف الگوی اعتبار سنجی</strong>، میتوانیم یک پیامک توکن دار جدید ایجاد کنیم.</p>
<p>2- <strong>نام الگو</strong>؛ اسم تمپلیت هست که در ساختار کد از آن استفاده میکنیم.</p>
<p>3- متنی که قرار است به کاربران ارسال شود در <strong>متن الگوی پیامک</strong> نوشته میشود.</p>
<blockquote>
<p><span class="rtl-text">بخش متغیر محتوای متن ما؛ <span class="en-text">%token</span> میباشد که در view جنگو آنرا مقدار دهی میکنیم.</span></p>
</blockquote>
<p><strong>برای استفاده از سرویس پیامکی کاوه نگار لازم است که کابخانه آنرا نصب کنیم.</strong></p>
<p><code>Terminal</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">terminal</span>
        </div>
    <pre><span></span>pip install kavenegar
</pre></div>

<p><strong>ساختار پیامک های توکن دار و عادی:</strong></p>
<p>اولی برای پیامک های توکن دار و دومی برای پیامک های عادی استفاده میشود.</p>
<p><code>app directory(cart)/commom/KaveSms.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">kavenegar</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">urllib.error</span> <span class="kn">import</span> <span class="n">HTTPError</span>


<span class="k">def</span> <span class="nf">send_sms_with_template</span><span class="p">(</span><span class="n">receptor</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">template</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        sending sms that needs template</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">api</span> <span class="o">=</span> <span class="n">KavenegarAPI</span><span class="p">(</span><span class="s1">&#39;در بخش حساب من API Key&#39;</span><span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;receptor&#39;</span><span class="p">:</span> <span class="n">receptor</span><span class="p">,</span>
            <span class="s1">&#39;template&#39;</span><span class="p">:</span> <span class="n">template</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">tokens</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">params</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">verify_lookup</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="n">APIException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>


<span class="c1"># ---------------------------------------</span>
<span class="k">def</span> <span class="nf">send_sms_normal</span><span class="p">(</span><span class="n">receptor</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">api</span> <span class="o">=</span> <span class="n">KavenegarAPI</span><span class="p">(</span><span class="s1">&#39;در بخش حساب من API Key&#39;</span><span class="p">)</span>

        <span class="n">params_buyer</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;receptor&#39;</span><span class="p">:</span> <span class="n">receptor</span><span class="p">,</span>
            <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
            <span class="s1">&#39;sender&#39;</span><span class="p">:</span> <span class="s1">&#39;10005000505077&#39;</span>
        <span class="p">}</span>

        <span class="n">response</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">sms_send</span><span class="p">(</span><span class="n">params_buyer</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">APIException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">HTTPError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>برای راحتی کدهای ارسال پیام ر به صورت تابع نوشته و برای استفاده از آنها در view تابع مدنظر را صدا میزنیم، تا از تکرار کد جلوگیری شود.</p>
<p>1- در تابع <strong>send_sms_with_template</strong>:</p>
<ul>
<li>
<p><strong>receptor</strong> =&gt; شماره گیرنده پیام میباشد(مشتریان و خریداران فروشگاه)</p>
</li>
<li>
<p><strong>tokens</strong> =&gt; یک دیکشنری، شامل متغیرهای محتوای متن میباشد (مثال: {'token': 254168})</p>
</li>
<li>
<p><strong>template</strong> =&gt; همان  <strong>نام الگو</strong> میباشد؛ که در بخش <strong>تعریف الگوی اعتبار سنجی</strong> آنرا تعریف کرده ایم.</p>
</li>
</ul>
<blockquote>
<p><span class="rtl-text">در این حالت دیگر لازم نیست متنی بنویسیم و فقط مقدار توکن ها را ارسال میکنیم، تا در محتوای متن اعتبارسنجی بجای (<span class="en-text">%token</span>) قرار گرفته و برای کاربر ارسال شود.</span></p>
</blockquote>
<p>2- در تابع <strong>send_sms_normal</strong>:</p>
<ul>
<li>
<p><strong>receptor</strong> =&gt; شماره گیرنده پیام میباشد(مشتریان و خریداران فروشگاه)</p>
</li>
<li>
<p><strong>message</strong> =&gt; محتوای متن پیام.</p>
</li>
</ul>
<p><strong>این کد ها را در فایل KaveSms.py نوشته و آنرا در اپ cart قرار میدهیم.</strong></p>
<blockquote>
<p>حال هرجا نیاز داشته باشیم، یکی از توابع آنرا ایمپورت کرده و آرگومان ها را برایش مشخص میکنیم.</p>
</blockquote>
<h3 id="pydh-szy-dryft-shmrh-khrbr">پیاده سازی دریافت شماره کاربر</h3>
<p>در اپ orders فایل urls.py را ایجاد میکنیم.</p>
<p><strong>در آن سه url میسازیم؛</strong><br />
1- برای دریافت شماره تلفن <br />
2- برای دریافت کد تایید  <br />
3- برای دریافت اطلاعات گیرنده سفارش</p>
<p><code>app directory(orders)/urls.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">views</span>


<span class="n">app_name</span> <span class="o">=</span> <span class="s1">&#39;orders&#39;</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;verify-phone&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">verify_phone</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;verify_phone&#39;</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;verify-code&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">verify_code</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;verify_code&#39;</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;order-create&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">order_create</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;order_create&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>

<p><strong>معرفی این فایل به پروژه:</strong></p>
<p><code>project directory/urls.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ...</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;order/&#39;</span><span class="p">,</span> <span class="n">include</span><span class="p">(</span><span class="s1">&#39;orders.urls&#39;</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;orders&#39;</span><span class="p">)),</span>
<span class="p">]</span>
</pre></div>

<p><strong>نکته:</strong> در اپ cart برای تمپلیت سبد خرید، یک دکمه برای <strong>ادامه خرید</strong> ایجاد کرده بودیم، حالا برای href آن url (آدرس) verify-phone را مشخص میکنیم.</p>
<blockquote>
<p>برای راحتی کد های طولانی را collapse کردیم.(بستیم)</p>
</blockquote>
<p><code>app(cart)/templates/cart/cart_detail.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">&#39;parent/base/base_template.html&#39;</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">load</span> <span class="nv">static</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}</span><span class="x">products</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
<span class="x">    &lt;div class=&quot;header&quot;&gt;</span>
<span class="x">        &lt;h1&gt;سبد خرید&lt;/h1&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;div class=&quot;cart-content&quot;&gt;</span>
<span class="x">&gt;       </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">item</span> <span class="k">in</span> <span class="nv">cart</span> <span class="p">...</span> <span class="cp">%}</span>


<span class="x">&gt;       &lt;div class=&quot;cart-total-price&quot;...&gt;</span>


<span class="x">        &lt;div class=&quot;checkout-button&quot;&gt;</span>
<span class="x">            &lt;div class=&quot;continue-btn&quot;&gt;&lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;orders:verify_phone&#39;</span> <span class="cp">%}</span><span class="x">&quot;&gt;ادامه خرید&lt;/a&gt;&lt;/div&gt;</span>
<span class="x">            &lt;div class=&quot;back-btn&quot;&gt;&lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s2">&quot;shop:products-list&quot;</span> <span class="cp">%}</span><span class="x">&quot;&gt;برگشت به لیست محصولات&lt;/a&gt;&lt;/div&gt;</span>
<span class="x">        &lt;/div&gt;</span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js&quot; integrity=&quot;sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==&quot; crossorigin=&quot;anonymous&quot; referrerpolicy=&quot;no-referrer&quot;&gt;&lt;/script&gt;</span>

<span class="x">&gt;    &lt;script...&gt;</span>
<span class="x">       </span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre></div>

<p>در اپ order فایل forms.py را ایجاد کرده و در آن یک فرم برای دریافت شماره تلفن کاربر و اعتبارسنجی آن ایجاد میکنیم.</p>
<p><code>app directory(orders)/forms.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">class</span> <span class="nc">PhoneVerificationForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">phone_number</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clean_phone_number</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">phone_number</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;phone_number&#39;</span><span class="p">]</span>

        <span class="c1"># conditions....</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">phone_number</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">forms</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Phone number must be digit&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">phone_number</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">11</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">forms</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Phone number must be 11 digits&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">phone_number</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;09&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">forms</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Phone number must start with 09&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">phone_number</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>پس از ایجاد فیلد شماره تلفن، برای آن اعتبارسنجی انجام میدهیم.</p>
<p>1- شماره تلفن باید به عدد باشد.</p>
<p>2- تعداد ارقام آن باید 11 تا باشد.</p>
<p>3- باید با 09 شروع شود.</p>
<p>نهایتا اگر مشکلی نداشت آنرا return میکنیم.</p>
<p><strong>ایجاد view برای دریافت و بررسی شماره تلفن:</strong></p>
<p><code>app directory(orders)/views.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">messages</span>
<span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">cart.common.KaveSms</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">random</span>


<span class="c1"># Create your views here.</span>
<span class="k">def</span> <span class="nf">verify_phone</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_authenticated</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;orders:order_create&#39;</span><span class="p">)</span>
    <span class="c1"># ———————————————————————————————————————————</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">PhoneVerificationForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="n">phone</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;phone_number&#39;</span><span class="p">)</span>

            <span class="c1"># verification code</span>
            <span class="n">code</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="s1">&#39;0123456789&#39;</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;token&#39;</span><span class="p">:</span> <span class="n">code</span><span class="p">}</span>

            <span class="c1"># save in session...</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;verification_code&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">code</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">phone</span>

            <span class="c1"># send SMS</span>
            <span class="n">send_sms_with_template</span><span class="p">(</span><span class="n">phone</span><span class="p">,</span> <span class="n">tokens</span><span class="p">,</span> <span class="s1">&#39;verification_code&#39;</span><span class="p">)</span>

            <span class="c1"># success message</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Your verification code has been sent.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;orders:verify_code&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">PhoneVerificationForm</span><span class="p">()</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;forms/verify_phone.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<blockquote>
<p>اگر کاربر در وبسایت لاگین کرده باشد (یعنی anonymous-user نباشد)؛ متد is_authenticated مقدار True را برمیگرداند.</p>
</blockquote>
<p>1- اگر کاربر لاگین کرده باشد، دیگر لازم نیست که شماره تلفن وارد کند؛ بنابراین آن کاربر را به صفحه اطلاعات گیرنده سفارش (یعنی order_create) منتقل میکنیم.</p>
<p>2- وقتی کاربر شماره تلفن را وارد کرد و آنرا ارسال کرد، شماره تلفن را به فرم میفرستیم تا اعتبارسنجی شود؛ چنانچه مشکلی نداشته باشد آنرا در یک متغیر ذخیره میکنیم.</p>
<p>3- با استفاده از کتابخانه random یک کد 6 رقمی(تعداد ارقام دلخواه است) ایجاد میکنیم و آنرا در یک دیکشنری ذخیره میکنیم.</p>
<blockquote>
<p>این دیکشنری را به API سرویس پیامکی ارسال میکنیم، تا با استفاده از آن مقدار، کد تایید را به کاربر ارسال کند.</p>
</blockquote>
<p>4- کد تایید و شماره تلفن را در session ذخیره میکنیم.(تا در view های بعدی هم به آنها دسترسی داشته باشیم.)</p>
<p>5- شماره تلفن کاربر، دیکشنری tokens و اسم تمپلیت(همان نام الگو در بخش اعتبارسنجی وبسایت) را به API  سامانه پیامکی ارسال میکنیم. / سامانه پیامکی با استفاده از آنها پیام را به کاربر ارسال میکند.</p>
<p>6- پیام "کد تایید برای شما ارسال شد" را با استفاده از ماژول messages به کاربر نشان میدهیم. / در پایان کاربر را به view بعدی یعنی verify-code منتقل میکنیم.</p>
<p><strong>ایجاد تمپلیت verify_phone.html</strong></p>
<p><code>app (order)/templates/forms/verify_phone.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="x">&lt;h2&gt;verification phone&lt;/h2&gt;</span>

<span class="x">&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">csrf_token</span> <span class="cp">%}</span>

<span class="x">    </span><span class="cp">{{</span> <span class="nv">form.as_p</span> <span class="cp">}}</span>

<span class="x">    &lt;input type=&quot;submit&quot; value=&quot;Send&quot;&gt;</span>
<span class="x">&lt;/form&gt;</span>

<span class="cp">{%</span> <span class="k">for</span> <span class="nv">message</span> <span class="k">in</span> <span class="nv">messages</span> <span class="cp">%}</span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">message</span> <span class="cp">}}</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
</pre></div>

<h3 id="rsl-w-brrsy-khd-tyyd-bh-shmrh-khrbr">ارسال و بررسی کد تایید به شماره کاربر</h3>
<p>برای کد تایید فقط در تمپلیت یک فرم ایجاد کرده و مقادیر آن را با دستور <strong>request.POST</strong> دریافت میکنیم.</p>
<p><strong>ایجاد view برای دریافت و بررسی کد تایید:</strong></p>
<p><code>app directory(orders)/views.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">def</span> <span class="nf">verify_code</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">received_code</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;code&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">received_code</span><span class="p">:</span>
            <span class="n">verification_code</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;verification_code&#39;</span><span class="p">]</span>
            <span class="n">phone</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">received_code</span> <span class="o">==</span> <span class="n">verification_code</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ShopUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">phone</span><span class="o">=</span><span class="n">phone</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="n">user</span> <span class="o">=</span> <span class="n">ShopUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">phone</span><span class="o">=</span><span class="n">phone</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">characters</span> <span class="o">=</span> <span class="s1">&#39;QWERTYUIOPASDFGHJKLZXCVBNM-0123456789-@_qwertyuiopasdfghjklzxcvbnm&#39;</span>
                    <span class="n">user_password</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">characters</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

                    <span class="n">user</span> <span class="o">=</span> <span class="n">ShopUser</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create_user</span><span class="p">(</span><span class="n">phone</span><span class="o">=</span><span class="n">phone</span><span class="p">)</span>
                    <span class="n">user</span><span class="o">.</span><span class="n">set_password</span><span class="p">(</span><span class="n">user_password</span><span class="p">)</span>
                    <span class="n">user</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                    <span class="c1"># send SMS:</span>
                    <span class="n">send_data</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;token1&#39;</span><span class="p">:</span> <span class="n">phone</span><span class="p">,</span>
                        <span class="s1">&#39;token2&#39;</span><span class="p">:</span> <span class="n">user_password</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="n">send_sms_with_template</span><span class="p">(</span><span class="n">phone</span><span class="p">,</span> <span class="n">send_data</span><span class="p">,</span> <span class="s1">&#39;create-account&#39;</span><span class="p">)</span>

                <span class="c1"># ——————————————— login user in website ———————————————</span>
                <span class="n">login</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span>

                <span class="c1"># —————————— clean code &amp; phone from session ——————————</span>
                <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;verification_code&#39;</span><span class="p">]</span>
                <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span>

                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;orders:order_create&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;Your verification code does not match.&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;forms/verify_code.html&#39;</span><span class="p">)</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>1- وقتی کاربر کد تایید را ارسال کرد، با دستور <strong>request.POST.get('code')</strong> آنرا دریافت کرده و در یک متغیر ذخیره میکنیم.</p>
<p>2- کد تایید و شماره تلفن کاربر، را از session دریافت کرده و در متغیر ذخیره میکنیم.</p>
<p>3- حالا بررسی میکنیم که کد تایید ارسال شده توسط کاربر با کد تاییدی که ما برایش ارسال کردیم تطابق دارد یا نه!!!</p>
<ul>
<li>
<p>اگر کد تایید تطابق نداشت یک پیام به کاربر نشان میدهیم. "کد تایید صحیح نمیباشد یا تطابق ندارد."</p>
</li>
<li>
<p>حالا اگر کد تایید درست بود؛ دو حالت وجود دارد ، اگر کاربر حساب ندارد یک حساب برایش ایجاد میکنیم و با آن لاگین میکنیم ولی اگر حساب داشته باشد با همان حساب لاگین میشویم.</p>
</li>
</ul>
<p>4- بررسی میکنیم کاربری با این شماره تلفن وجو دارد یا نه! اگر وجود داشت اطلاعات آن کاربر را در یک متغیر ذخیره میکنیم تا بتوانیم لاگین شویم.</p>
<p>5- اگر کاربر وجود نداشت؛ یک حساب کاربری با رمز رندوم برایش ایجاد کرده و آن اطلاعات (نام کاربری(شماره تلفن) و رمز عبور) را برایش پیامک میکنیم.</p>
<p>6- کاربر را در وبسایت لاگین میکنیم.</p>
<p>7- شماره تلفن و کد تایید را از session پاک کرده و کاربر را به صفحه تکمیل فرم اطلاعات گیرنده سفارش(order-create) منتقل میکنیم.</p>
<p><strong>ایجاد تمپلیت برای دریافت کد تایید:</strong></p>
<p><code>app (order)/templates/forms/verify_code.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="x">&lt;h2&gt;verification code&lt;/h2&gt;</span>

<span class="x">&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">csrf_token</span> <span class="cp">%}</span>

<span class="x">    &lt;input type=&quot;text&quot; name=&quot;code&quot; placeholder=&quot;Enter your code&quot;&gt;</span>

<span class="x">    &lt;input type=&quot;submit&quot; value=&quot;send&quot;&gt;</span>
<span class="x">&lt;/form&gt;</span>

<span class="cp">{%</span> <span class="k">for</span> <span class="nv">message</span> <span class="k">in</span> <span class="nv">messages</span> <span class="cp">%}</span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">message</span> <span class="cp">}}</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
</pre></div>

<h3 id="dryft-mshkhst-sfrsh-z-khrbr">دریافت مشخصات سفارش از کاربر</h3>
<p>در اپ order، دو مدل ایجاد کردیم؛ Order(اطلاعت گیرنده سفارش)، OrderItem(آیتم های سفارش همان کالاهای سفارش داده شده)</p>
<blockquote>
<p>حالا یک فرم ایجاد میکنیم که اطلاعات گیرنده سفارش را از کاربر دریافت میکند و پس از آن براساس اطلاعات cart(سبد خرید) آبجکت های مدل OrderItem را ایجاد میکنیم.</p>
</blockquote>
<p><strong>ایجاد فرم اطلاعات گیرنده سفارش:</strong></p>
<p><code>app directory(orders)/forms.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">Order</span>


<span class="k">class</span> <span class="nc">OrderCreateForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">ModelForm</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Order</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;firstname&#39;</span><span class="p">,</span> <span class="s1">&#39;lastname&#39;</span><span class="p">,</span> <span class="s1">&#39;phone&#39;</span><span class="p">,</span> <span class="s1">&#39;address&#39;</span><span class="p">,</span> <span class="s1">&#39;postal_code&#39;</span><span class="p">,</span> <span class="s1">&#39;province&#39;</span><span class="p">,</span> <span class="s1">&#39;city&#39;</span><span class="p">]</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>فرم را از فیلدهای مدل Order ایجاد میکنیم.</p>
<p><strong>نکته:</strong> در این فرم شماره تلفن را نیز دریافت میکنیم، چون شماره تلفن گیرنده سفارش میباشد و ممکن است همان شماره کاربر نباشد.(شماره ای که با آن لاگین کرده است.)</p>
<p><strong>ایجاد view برای فرم اطلاعات گیرنده سفارش:</strong></p>
<p>این view به url (آدرس) order-create متصل میباشد.</p>
<p><code>app directory(orders)/views.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">.forms</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">OrderItem</span><span class="p">,</span> <span class="n">Order</span>
<span class="kn">from</span> <span class="nn">cart.cart</span> <span class="kn">import</span> <span class="n">Cart</span>
<span class="c1"># app &quot;cart&quot; =&gt; &quot;cart.py&quot; file =&gt; &quot;Cart&quot; class</span>


<span class="nd">@login_required</span>
<span class="k">def</span> <span class="nf">order_create</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">cart</span> <span class="o">=</span> <span class="n">Cart</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">OrderCreateForm</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">():</span>
            <span class="c1"># Order Info</span>
            <span class="n">order</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">order</span><span class="o">.</span><span class="n">buyer</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
            <span class="n">order</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

            <span class="c1"># ———————————— Order Item ————————————</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">cart</span><span class="p">:</span>
                <span class="n">OrderItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                    <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span>
                    <span class="n">product</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;product&#39;</span><span class="p">],</span>
                    <span class="n">price</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">],</span>
                    <span class="n">quantity</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;quantity&#39;</span><span class="p">],</span>
                    <span class="n">weight</span><span class="o">=</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;weight&#39;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="c1"># —————————————————————————————————————</span>

            <span class="c1"># clean cart</span>
            <span class="n">cart</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;order_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">id</span>

            <span class="c1"># انتقال به صفحه پرداخت هزینه سفارش</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s1">&#39;orders:request&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">form</span> <span class="o">=</span> <span class="n">OrderCreateForm</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;forms/order_create.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;form&#39;</span><span class="p">:</span> <span class="n">form</span><span class="p">,</span> <span class="s1">&#39;cart&#39;</span><span class="p">:</span> <span class="n">cart</span><span class="p">})</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>1- برای این view از دکوراتور <strong>login_required</strong> استفاده میکنیم؛ چون برای این صفحه کاربر باید در وبسایت لاگین کرده باشد.</p>
<p>2- یک آبجکت از کلاس Cart ایجاد میکنیم. / با استفاده از آن آبجکت های OrderItem را ایجاد میکنیم.</p>
<p>3- اطلاعات گیرنده سفارش را ا تمپلیت دریافت کرده و فیلدهای آنرا اعتبارسنجی میکنیم.</p>
<p>4- چنانچه فیلدها مشکلی نداشته باشند، با متد save اطلاعات سفارش را به همراه کاربر فعلی در دیتابیس ذخیره میکنیم.</p>
<p>5- روی آبجکت cart حلقه میزنیم و براساس اطلاعات آن، برای مدل OrderItem آبجکت های مربوط به سفارش فعلی را ایجاد میکنیم.</p>
<blockquote>
<p>وقتی روی آبجکت cart حلقه میزنیم، در هر ایتریشن یک محصول از سبد خرید با اطلاعاتی نظیر تعداد کالا، قیمت کالا، و... را برمیگرداند.</p>
<p>هر item یک دیکشنری از اطلاعات محصول میباشد. / با توجه به هر آیتم یک آبجکت برای مدل OrderItem ایجاد میکنیم.</p>
</blockquote>
<p>6- اطلاعات cart (سبد خرید) را با متد clear پاک میکنیم.</p>
<p>7- آیدی سفارش (order_id) را در session ذخیره میکنیم. / در view های بعدی استفاده میشود.</p>
<p>8- کاربر را به صفحه درگاه پرداخت منتقل میکنیم. / در ادامه url و view آنرا ایجاد میکنیم.</p>
<p><strong>ایجاد تمپلیت فرم اطلاعات گیرنده سفارش:</strong></p>
<p><code>app(orders)/templates/forms/order_create.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="x">&lt;h2&gt;Your chosen products&lt;/h2&gt;</span>

<span class="x">&lt;ul&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">item</span> <span class="k">in</span> <span class="nv">cart</span> <span class="cp">%}</span>
<span class="x">        &lt;li&gt;</span>
<span class="x">            </span><span class="cp">{{</span> <span class="nv">item.quantity</span> <span class="cp">}}</span><span class="x"> X </span><span class="cp">{{</span> <span class="nv">item.product.name</span> <span class="cp">}}</span><span class="x"> =&gt;</span>
<span class="x">            </span><span class="cp">{{</span> <span class="nv">item.total</span> <span class="cp">}}</span>
<span class="x">        &lt;/li&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="x">&lt;/ul&gt;</span>

<span class="x">&lt;!-- ———————————————————————————————————————————————————————— --&gt;</span>

<span class="x">&lt;h2&gt;Complete the order information&lt;/h2&gt;</span>

<span class="x">&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">csrf_token</span> <span class="cp">%}</span>
<span class="x">    </span>
<span class="x">    </span><span class="cp">{{</span> <span class="nv">form.as_p</span> <span class="cp">}}</span>

<span class="x">    &lt;input type=&quot;submit&quot; value=&quot;send&quot;&gt;</span>
<span class="x">&lt;/form&gt;</span>
</pre></div>

<h3 id="tsl-drgh-prdkht-zryn-pl-bh-frwshgh">اتصال درگاه پرداخت (زرین پال) به فروشگاه</h3>
<p>برای استفاده از درگاه پرداخت، در آن وبسایت ثبت نام کرده و عملیات احراز هویت را تکمیل میکنیم.</p>
<p>لازم است یکسری تنظیمات را در <strong>settings.py</strong> پیاده سازی کنیم:</p>
<p><code>project directory/settings.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="c1"># ZarinPal Info</span>
<span class="n">MERCHANT</span> <span class="o">=</span> <span class="s2">&quot;00000000-0000-0000-0000-000000000000&quot;</span>
<span class="n">SANDBOX</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<ul>
<li>
<p>وقتی برای درگاه پرداخت ثبت نام کردیم، توی تنظیمات یک کد برای ما ایجاد میشود؛ آنرا برای متغیر MERCHANT ست میکنیم. / این مقدار فعلی ساختار آنرا نشان میدهد.</p>
</li>
<li>
<p>برای SANDBOX مقدار False را مشخص میکنیم؛ تا از تنظیمات پیشفرض استفاده نکند.</p>
</li>
</ul>
<blockquote>
<p>در صورت نبود ماژول <strong>requests</strong> آنرا نصب میکنیم.</p>
<p>pip install requests</p>
</blockquote>
<p><strong>ایجاد url های مربوط به درگاه پرداخت:</strong></p>
<p>دو تا url به url های اپ orders اضافه میکنیم.</p>
<p><code>app directory(orders)/urls.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ...</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;request/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">send_request</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;request&#39;</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;verify/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">verify</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;verify&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>

<blockquote>
<p>view های مربوط به این دو url  را هم ایجاد میکنیم.</p>
<p>اولی برای مراحل قبل از ورود به درگاه پرداخت هست و دیگری مراحل بعد از اینکه از درگاه پرداخت برمیگردد.</p>
</blockquote>
<p><strong>ایجاد view های مربوط به درگاه پرداخت:</strong></p>
<p>این داده ها را از گیتهابی که در سایت زرین پال گفته شده برمیداریم؛ ولی ساختار آنها ایراداتی داره بنابراین از نسخه ویرایش شده در pull request آن  استفاده میکنیم که آن هم باز نیاز به تغییراتی دارد.</p>
<p><code>github(zarinpal)</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.conf</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">redirect</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>


<span class="c1">#? sandbox merchant </span>
<span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">SANDBOX</span><span class="p">:</span>
    <span class="n">sandbox</span> <span class="o">=</span> <span class="s1">&#39;sandbox&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">sandbox</span> <span class="o">=</span> <span class="s1">&#39;www&#39;</span>


<span class="n">ZP_API_REQUEST</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">sandbox</span><span class="si">}</span><span class="s2">.zarinpal.com/pg/rest/WebGate/PaymentRequest.json&quot;</span>
<span class="n">ZP_API_VERIFY</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">sandbox</span><span class="si">}</span><span class="s2">.zarinpal.com/pg/rest/WebGate/PaymentVerification.json&quot;</span>
<span class="n">ZP_API_STARTPAY</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">sandbox</span><span class="si">}</span><span class="s2">.zarinpal.com/pg/StartPay/&quot;</span>

<span class="n">amount</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># Rial / Required</span>
<span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;توضیحات مربوط به تراکنش را در این قسمت وارد کنید&quot;</span>  <span class="c1"># Required</span>
<span class="n">phone</span> <span class="o">=</span> <span class="s1">&#39;YOUR_PHONE_NUMBER&#39;</span>  <span class="c1"># Optional</span>
<span class="c1"># Important: need to edit for real server.</span>
<span class="n">CallbackURL</span> <span class="o">=</span> <span class="s1">&#39;http://127.0.0.1:8080/verify/&#39;</span>


<span class="k">def</span> <span class="nf">send_request</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;MerchantID&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">MERCHANT</span><span class="p">,</span>
        <span class="s2">&quot;Amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
        <span class="s2">&quot;Description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
        <span class="s2">&quot;Phone&quot;</span><span class="p">:</span> <span class="n">phone</span><span class="p">,</span>
        <span class="s2">&quot;CallbackURL&quot;</span><span class="p">:</span> <span class="n">CallbackURL</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># set content length by data</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span> <span class="s1">&#39;content-type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span> <span class="s1">&#39;content-length&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">ZP_API_REQUEST</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">response_json</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">authority</span> <span class="o">=</span> <span class="n">response_json</span><span class="p">[</span><span class="s1">&#39;Authority&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">response_json</span><span class="p">[</span><span class="s1">&#39;Status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">ZP_API_STARTPAY</span><span class="o">+</span><span class="n">authority</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;response failed&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Timeout Error&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Connection Error&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">authority</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authority&#39;</span><span class="p">)</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Status&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;OK&#39;</span> <span class="ow">and</span> <span class="n">authority</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;MerchantID&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">MERCHANT</span><span class="p">,</span>
            <span class="s2">&quot;Amount&quot;</span><span class="p">:</span> <span class="n">amount</span><span class="p">,</span>
            <span class="s2">&quot;Authority&quot;</span><span class="p">:</span> <span class="n">authority</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="c1"># set content length by data</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span> <span class="s1">&#39;content-type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span> <span class="s1">&#39;content-length&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">ZP_API_VERIFY</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="n">response_json</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
                <span class="n">reference_id</span> <span class="o">=</span> <span class="n">response_json</span><span class="p">[</span><span class="s1">&#39;RefID&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;successful , RefID: </span><span class="si">{</span><span class="n">reference_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;response failed&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Timeout Error&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Connection Error&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Not ok&#39;</span><span class="p">)</span>
</pre></div>

<p><strong>بریم این دو تا view را تغییر بدیم:</strong></p>
<p>1- amount, description, phone مقدار ثابت ندارند پس آنها را در view ها تعریف میکنیم نه به صورت یک متغیر.</p>
<p>2- برای CallbackURL باید آدرس حقیقی وبسایت را وارد کنیم ولی در حال حاضر از آدرس local-host با پورت 8000 استفاده میکنیم.</p>
<blockquote>
<p><span class="rtl-text"><strong>نکته:</strong> اگر یادتان باشد در فایل urls.py پروژه برای url های اپ order مشخص کردیم که با عبارت <span class="en-text">order/</span> شروع شوند در نتیجه باید order را قبل از verify اضافه کنیم.</span></p>
<p><span class="rtl-text">پس اینجا url ما میشود <span class="en-text">http://127.0.0.1:8000/order/verify/</span></span></p>
</blockquote>
<p><strong>ایجاد تغییرات در ویوی send_request:</strong></p>
<p>1- مقادیر لازم را از آبجکت سفارش فعلی میگیریم؛ بنابراین با استفاده از آیدی سفارش (order_id) که در view قبلی در سشن ذخیره کردیم آبجکت سفارش را از دیتابیس دریافت میکنیم.</p>
<p>2- برای توضیحات سفارش اسم محصولات خریداری شده را نمایش میدهیم./ روی order-item های این سفارش حلقه میزنیم و اسم محصول را به صورت رشته ذخیره میکنیم.</p>
<p>3- <strong>Amount:</strong> هزینه نهایی جهت پرداخت میباشد(هزینه محصولات + هزینه پستی)؛ با استفاده از متد <span class="en-text">get_final_cost()</span> برای آبجکت order آنرا بدست می آوریم.</p>
<p>4- شماره تلفن خریدار را با استفاده از دستور request.user.phone مشخص میکنیم.</p>
<p><strong>ایجاد تغییرات در ویوی verify:</strong></p>
<p>1- در این view هم با استفاده از order_id آبجکت سفارش فعلی را در یک متغیر ذخیره میکنیم.</p>
<p>2- مقدار <strong>Amount</strong> را با استفاده از متد <span class="en-text">get_final_cost()</span> محاسبه میکنیم.</p>
<p>3- <span class="rtl-text"> شرط <code>if response['Status'] == 100</code> باید به <code>if response_json['Status'] == 100</code> تغییر کند.</span></p>
<p>4- وقتی کد وضعیت 100 هست؛ یعنی پرداخت موفق بوده بنابراین باید <strong>موجودی آن محصولات</strong> و نیز <strong>وضعیت پرداخت کاربر</strong> تغییر کند.</p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">if</span> <span class="n">response_json</span><span class="p">[</span><span class="s1">&#39;Status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
    <span class="c1"># change inventory of products</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">item</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">inventory</span> <span class="o">-=</span> <span class="n">item</span><span class="o">.</span><span class="n">quantity</span>
        <span class="n">item</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

    <span class="c1"># change paid status...</span>
    <span class="n">order</span><span class="o">.</span><span class="n">paid</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">order</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>

<p><strong>نسخه تغییر یافته view های مربوط به درگاه پرداخت:</strong></p>
<p>در این نسخه تغییراتی که در بالا توضیح دادیم اعمال شده اند.</p>
<p><code>app directory(orders)/views.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="c1"># zarin pal info : اطلاعات درگاه پرداخت</span>

<span class="c1"># ? sandbox merchant</span>
<span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">SANDBOX</span><span class="p">:</span>
    <span class="n">sandbox</span> <span class="o">=</span> <span class="s1">&#39;sandbox&#39;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">sandbox</span> <span class="o">=</span> <span class="s1">&#39;www&#39;</span>


<span class="n">ZP_API_REQUEST</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">sandbox</span><span class="si">}</span><span class="s2">.zarinpal.com/pg/rest/WebGate/PaymentRequest.json&quot;</span>
<span class="n">ZP_API_VERIFY</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">sandbox</span><span class="si">}</span><span class="s2">.zarinpal.com/pg/rest/WebGate/PaymentVerification.json&quot;</span>
<span class="n">ZP_API_STARTPAY</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;https://</span><span class="si">{</span><span class="n">sandbox</span><span class="si">}</span><span class="s2">.zarinpal.com/pg/StartPay/&quot;</span>


<span class="c1"># Important: need to edit for real server.</span>
<span class="n">CallbackURL</span> <span class="o">=</span> <span class="s1">&#39;http://127.0.0.1:8000/order/verify/&#39;</span>


<span class="k">def</span> <span class="nf">send_request</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Order</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">))</span>

    <span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
        <span class="n">description</span> <span class="o">+=</span> <span class="n">item</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;, &#39;</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;MerchantID&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">MERCHANT</span><span class="p">,</span>
        <span class="s2">&quot;Amount&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">get_final_cost</span><span class="p">(),</span>
        <span class="s2">&quot;Description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
        <span class="s2">&quot;Phone&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">phone</span><span class="p">,</span>
        <span class="s2">&quot;CallbackURL&quot;</span><span class="p">:</span> <span class="n">CallbackURL</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># set content length by data</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span> <span class="s1">&#39;content-type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span> <span class="s1">&#39;content-length&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">ZP_API_REQUEST</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">response_json</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">authority</span> <span class="o">=</span> <span class="n">response_json</span><span class="p">[</span><span class="s1">&#39;Authority&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">response_json</span><span class="p">[</span><span class="s1">&#39;Status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">ZP_API_STARTPAY</span><span class="o">+</span><span class="n">authority</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;response failed&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Timeout Error&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Connection Error&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Order</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">))</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;MerchantID&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">MERCHANT</span><span class="p">,</span>
        <span class="s2">&quot;Amount&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">get_final_cost</span><span class="p">(),</span>
        <span class="s2">&quot;Authority&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authority&#39;</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># set content length by data</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span> <span class="s1">&#39;content-type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span> <span class="s1">&#39;content-length&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">ZP_API_VERIFY</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">response_json</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">reference_id</span> <span class="o">=</span> <span class="n">response_json</span><span class="p">[</span><span class="s1">&#39;RefID&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">response_json</span><span class="p">[</span><span class="s1">&#39;Status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">inventory</span> <span class="o">-=</span> <span class="n">item</span><span class="o">.</span><span class="n">quantity</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="c1"># change paid status...</span>
                <span class="n">order</span><span class="o">.</span><span class="n">paid</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">order</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;successful , RefID: </span><span class="si">{</span><span class="n">reference_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Error&#39;</span><span class="p">)</span>

        <span class="c1"># clean Order-Id from session</span>
        <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;order_id&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;response failed&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Timeout Error&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Connection Error&#39;</span><span class="p">)</span>
</pre></div>

<h3 id="sfht-wd-yt-prdkht-lyst-w-jzyyt-sfrsh">صفحات وضعیت پرداخت، لیست و جزئیات سفارش</h3>
<p>برای وضعیت پرداخت کاربر(پرداخت موفق و یا زمانیکه پرداخت با شکست مواجه میشود) یک تمپلیت ایجاد میکنیم. / این تمپلیت بجای HttpResponse در ویوی verify نمایش داده میشود.</p>
<p><strong>اعمال تغییرات در ویوی مربوط به verify:</strong></p>
<p><code>app directory(orders)/views.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">def</span> <span class="nf">verify</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Order</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order_id&#39;</span><span class="p">))</span>

    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;MerchantID&quot;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">MERCHANT</span><span class="p">,</span>
        <span class="s2">&quot;Amount&quot;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">get_final_cost</span><span class="p">(),</span>
        <span class="s2">&quot;Authority&quot;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Authority&#39;</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># set content length by data</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;accept&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span> <span class="s1">&#39;content-type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span> <span class="s1">&#39;content-length&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">ZP_API_VERIFY</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
            <span class="n">response_json</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
            <span class="n">reference_id</span> <span class="o">=</span> <span class="n">response_json</span><span class="p">[</span><span class="s1">&#39;RefID&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">response_json</span><span class="p">[</span><span class="s1">&#39;Status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">100</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">order</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">inventory</span> <span class="o">-=</span> <span class="n">item</span><span class="o">.</span><span class="n">quantity</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">product</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="c1"># change paid status...</span>
                <span class="n">order</span><span class="o">.</span><span class="n">paid</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">order</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>

                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;orders/payment-tracking.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">&#39;RefID&#39;</span><span class="p">:</span> <span class="n">reference_id</span><span class="p">,</span> <span class="s1">&#39;order_id&#39;</span><span class="p">:</span> <span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;orders/payment-tracking.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;success&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>

        <span class="c1"># clean Order-Id from session</span>
        <span class="k">del</span> <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;order_id&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;response failed&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">Timeout</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Timeout Error&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ConnectionError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s1">&#39;Connection Error&#39;</span><span class="p">)</span>
</pre></div>

<p><strong>ایجاد تمپلیت وضعیت پرداخت کاربر:</strong></p>
<p><code>app(orders)/templates/orders/payment-tracking.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">&#39;parent/base/base_template.html&#39;</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">load</span> <span class="nv">static</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}</span><span class="x">payment</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">success</span> <span class="cp">%}</span>
<span class="x">        &lt;div class=&quot;success&quot;&gt;</span>
<span class="x">            &lt;h2&gt;پرداخت موفق&lt;/h2&gt;</span>

<span class="x">            &lt;p&gt;شماره پیگیری: </span><span class="cp">{{</span> <span class="nv">RefID</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">            &lt;p&gt;شماره سفارش: </span><span class="cp">{{</span> <span class="nv">order_id</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">        &lt;/div&gt;</span>

<span class="x">    </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
<span class="x">        &lt;div class=&quot;failure&quot;&gt;</span>
<span class="x">            &lt;h2&gt;پرداخت ناموفق&lt;/h2&gt;</span>
<span class="x">            &lt;p&gt;پرداخت با شکست مواجه شد.&lt;/p&gt;</span>
<span class="x">        &lt;/div&gt;</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>

<span class="x">    &lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;shop:products-list&#39;</span> <span class="cp">%}</span><span class="x">&quot; class=&quot;back-btn&quot;&gt;بازگشت به لیست محصولات&lt;/a&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre></div>

<p><strong>ایجاد url  برای صفحات (لیست سفارشات و جزئیات هر سفارش):</strong></p>
<p><code>app directory(orders)/urls.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ...</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;orders-list/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">orders_list</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;orders_list&#39;</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;order-detail/&lt;int:order_id&gt;/&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">order_detail</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;order_detail&#39;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>

<p><strong>ایجاد view  برای صفحات (لیست سفارشات و جزئیات هر سفارش):</strong></p>
<p><code>app directory(orders)/views.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">def</span> <span class="nf">orders_list</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">user</span>
    <span class="n">orders</span> <span class="o">=</span> <span class="n">Order</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">buyer</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;orders&#39;</span><span class="p">:</span> <span class="n">orders</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;orders/order_list.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

<span class="c1"># —————————————————————————————————————————————————————————————————————</span>

<span class="k">def</span> <span class="nf">order_detail</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">order_id</span><span class="p">):</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Order</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="n">order_id</span><span class="p">)</span>
    <span class="n">order_items</span> <span class="o">=</span> <span class="n">OrderItem</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span>
        <span class="s1">&#39;order_items&#39;</span><span class="p">:</span> <span class="n">order_items</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;orders/order_detail.html&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<p>1- در view لیست سفارشات، تمام سفارشات مربوط به کاربر فعلی وبسایت را از دیتابیس دریافت کرده و در یک متغیر ذخیره میکنیم؛ آنرا به تمپلیت ارسال کرده و با استفاده از حلقه سفارشات کاربر را در آن صفحه نمایش میدهیم.</p>
<p>2- در view  جزئیات هر سفارش، با توجه به آیدی سفارش، آن سفارش را از دیتابیس دریافت میکنیم؛ آیتم های آن سفارش را هم دریافت میکنیم تا آنها را در تمپلیت نمایش دهیم.</p>
<p><strong>ایجاد تمپلیت برای نمایش لیست سفارشات کاربر:</strong></p>
<p><code>app(orders)/templates/orders/order_list.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">&#39;parent/base/base_template.html&#39;</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">load</span> <span class="nv">static</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}</span><span class="x">order&#39;s list</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
<span class="x">    &lt;h1&gt;لیست سفارشات&lt;/h1&gt;</span>

<span class="x">    </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">orders</span> <span class="cp">%}</span>
<span class="x">        &lt;table&gt;</span>
<span class="x">            &lt;thead&gt;</span>
<span class="x">                &lt;tr&gt;</span>
<span class="x">                    &lt;th&gt;شماره سفارش&lt;/th&gt;</span>
<span class="x">                    &lt;th&gt;تاریخ سفارش&lt;/th&gt;</span>
<span class="x">                    &lt;th&gt;وضعیت سفارش&lt;/th&gt;</span>
<span class="x">                &lt;/tr&gt;</span>
<span class="x">            &lt;/thead&gt;</span>

<span class="x">            &lt;tbody&gt;</span>
<span class="x">                </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">order</span> <span class="k">in</span> <span class="nv">orders</span> <span class="cp">%}</span>
<span class="x">                    &lt;tr&gt;</span>
<span class="x">                        &lt;td&gt;&lt;a href=&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;orders:order_detail&#39;</span> <span class="nv">order.id</span> <span class="cp">%}</span><span class="x">&quot;&gt;</span><span class="cp">{{</span> <span class="nv">order.id</span> <span class="cp">}}</span><span class="x">&lt;/a&gt;&lt;/td&gt;</span>

<span class="x">                        &lt;td&gt;</span><span class="cp">{{</span> <span class="nv">order.created</span> <span class="cp">}}</span><span class="x">&lt;/td&gt;</span>

<span class="x">                        </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">order.paid</span> <span class="cp">%}</span>
<span class="x">                            &lt;td&gt;پرداخت موفق ✔️&lt;/td&gt;</span>
<span class="x">                        </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
<span class="x">                            &lt;td&gt;پرداخت ناموفق ✖️&lt;/td&gt;</span>
<span class="x">                        </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
<span class="x">                    &lt;/tr&gt;</span>
<span class="x">                </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="x">            &lt;/tbody&gt;</span>
<span class="x">        &lt;/table&gt;</span>

<span class="x">    </span><span class="cp">{%</span> <span class="k">else</span> <span class="cp">%}</span>
<span class="x">        هیچ سفارشی ثبت نشده است!</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre></div>

<p><strong>ایجاد تمپلیت برای نمایش جزئیات هر سفارش:</strong></p>
<p><code>app(orders)/templates/orders/order_detail.html</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">jinja</span>
        </div>
    <pre><span></span><span class="cp">{%</span> <span class="k">extends</span> <span class="s1">&#39;parent/base/base_template.html&#39;</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">load</span> <span class="nv">static</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">block</span> <span class="nv">title</span> <span class="cp">%}</span><span class="x">order detail</span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">block</span> <span class="nv">content</span> <span class="cp">%}</span>
<span class="x">    &lt;h1&gt;سفارش </span><span class="cp">{{</span> <span class="nv">order.id</span> <span class="cp">}}</span><span class="x">&lt;/h1&gt;</span>

<span class="x">    &lt;h2&gt;order item&#39;s&lt;/h2&gt;</span>
<span class="x">    &lt;div class=&quot;products&quot;&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">for</span> <span class="nv">order_item</span> <span class="k">in</span> <span class="nv">order_items</span> <span class="cp">%}</span>
<span class="x">            &lt;div class=&quot;product&quot;&gt;</span>
<span class="x">                &lt;img src=&quot;</span><span class="cp">{{</span> <span class="nv">order_item.product.images.first.image_file.url</span> <span class="cp">}}</span><span class="x">&quot; alt=&quot;&quot; width=&quot;150px&quot;&gt;</span>
<span class="x">                &lt;h3&gt;</span><span class="cp">{{</span> <span class="nv">order_item.product.name</span> <span class="cp">}}</span><span class="x">&lt;/h3&gt;</span>

<span class="x">                &lt;span&gt;</span><span class="cp">{{</span> <span class="nv">order_item.quantity</span> <span class="cp">}}</span><span class="x"> X </span><span class="cp">{{</span> <span class="nv">order_item.price</span> <span class="cp">}}</span><span class="x"> =&gt; </span><span class="cp">{{</span> <span class="nv">order_item.get_cost</span> <span class="cp">}}</span><span class="x">&lt;/span&gt;</span>
<span class="x">            &lt;/div&gt;</span>
<span class="x">            &lt;hr&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="x">        </span>
<span class="x">    &lt;/div&gt;</span>

<span class="x">    &lt;hr&gt;</span>

<span class="x">    &lt;div class=&quot;info&quot;&gt;</span>
<span class="x">        &lt;h2&gt;order info&lt;/h2&gt;</span>

<span class="x">        &lt;p&gt;first name: </span><span class="cp">{{</span> <span class="nv">order.firstname</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">        &lt;p&gt;last name: </span><span class="cp">{{</span> <span class="nv">order.lastname</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">        &lt;p&gt;phone: </span><span class="cp">{{</span> <span class="nv">order.phone</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>

<span class="x">        &lt;p&gt;province: </span><span class="cp">{{</span> <span class="nv">order.province</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">        &lt;p&gt;city: </span><span class="cp">{{</span> <span class="nv">order.city</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">        &lt;p&gt;full address: </span><span class="cp">{{</span> <span class="nv">order.address</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">        &lt;p&gt;postal code: </span><span class="cp">{{</span> <span class="nv">order.postal_code</span> <span class="cp">}}</span><span class="x">&lt;/p&gt;</span>
<span class="x">    &lt;/div&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
</pre></div>

<h3 id="qblyt-khrwjy-fyl-excel-z-sfrsh-h-dr-pnl-dmyn">قابلیت خروجی فایل Excel از سفارش ها در پنل ادمین</h3>
<p>میخواهیم اکشنی ایجاد کنیم که اطلاعات سفارش ها را به صورت Excel در خروجی تحویل دهد.</p>
<blockquote>
<p>برای این کار لازم است که پکیج <strong>openpyxl</strong> را نصب کنیم.</p>
</blockquote>
<p><code>terminal</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">terminal</span>
        </div>
    <pre><span></span>pip install openpyxl
</pre></div>

<p><strong>بریم اکشن را در فایل admin.py ایجاد کنیم:</strong></p>
<p>لازم است که HttpResponse و openpyxl را ایمپورت کنیم.</p>
<p><code>app directory(orders)/admin.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponse</span>
<span class="kn">import</span> <span class="nn">openpyxl</span>


<span class="c1"># ------------------------------- My Actions -------------------------------</span>
<span class="k">def</span> <span class="nf">export_to_excel</span><span class="p">(</span><span class="n">modeladmin</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">queryset</span><span class="p">):</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;</span><span class="p">)</span>
    <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;attachment; filename=&quot;orders.xlsx&quot;&#39;</span>

    <span class="c1"># ---------------------------</span>
    <span class="n">wb</span> <span class="o">=</span> <span class="n">openpyxl</span><span class="o">.</span><span class="n">Workbook</span><span class="p">()</span>
    <span class="n">ws</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">active</span>
    <span class="n">ws</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Orders&#39;</span>
    <span class="c1"># ---------------------------</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="s1">&#39;First Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Last Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Phone&#39;</span><span class="p">,</span> <span class="s1">&#39;Address&#39;</span><span class="p">,</span> <span class="s1">&#39;Postal Code&#39;</span><span class="p">,</span> <span class="s1">&#39;City&#39;</span><span class="p">,</span> <span class="s1">&#39;Province&#39;</span><span class="p">,</span> <span class="s1">&#39;Paid&#39;</span><span class="p">,</span> <span class="s1">&#39;Created&#39;</span><span class="p">]</span>

    <span class="n">ws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
    <span class="c1"># ---------------------------</span>
    <span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
        <span class="n">created</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">created</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

        <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">firstname</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">lastname</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">phone</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">postal_code</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">city</span><span class="p">,</span>
               <span class="n">order</span><span class="o">.</span><span class="n">province</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">paid</span><span class="p">,</span> <span class="n">created</span><span class="p">]</span>

        <span class="n">ws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="c1"># --------------------------</span>
    <span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>


<span class="n">export_to_excel</span><span class="o">.</span><span class="n">short_description</span> <span class="o">=</span> <span class="s1">&#39;export to excel&#39;</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<blockquote>
<p>این اکشن به مدیر سایت امکان می‌دهد تا داده‌های یک queryset (مجموعه‌ای از داده‌ها که از یک مدل خاص در پایگاه داده جنگو انتخاب شده‌اند) را به صورت یک فایل Excel (با پسوند .xlsx) دانلود کند.</p>
</blockquote>
<p>1- <strong>نوشتن اکشن:</strong> برای نوشتن اکشن، یک تابع ایجاد میکنیم که modeladmin, request, queryset را به عنوان <strong>پارامتر</strong> دریافت میکند.</p>
<ul>
<li>
<p><strong>modeladmin:</strong> ارجاع میدهد به کلاس modeladmin.(یک نمونه از مدل ادمین که تابع اکشن از آن فراخوانی می‌شود.)</p>
</li>
<li>
<p><strong>request:</strong> درخواست HTTP که از سمت کلاینت (کاربر) به سرور ارسال شده است و باعث میشود که اکشن فعال شود.</p>
</li>
<li>
<p><strong>queryset:</strong> مجموعه‌ای از اشیاء که کاربر در پنل ادمین انتخاب کرده است.(در این اکشن؛ سفارش هایی که ادمین در <strong>پنل ادمین</strong> انتخاب کرده است تا به صورت اکسل خروجی داده شوند.)</p>
</li>
</ul>
<p>2- <strong>ایجاد پاسخ برای دانلود</strong>:</p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&#39;</span><span class="p">)</span>

<span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;attachment; filename=&quot;orders.xlsx&quot;&#39;</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<ul>
<li>
<p><strong>کلاس HttpResponse:</strong> کلاس پاسخ‌دهی در جنگو است که در اینجا برای ایجاد فایل Excel استفاده شده است.</p>
<blockquote>
<p><strong>HttpResponse:</strong> شیئی که برای ارسال داده‌ها به مرورگر (کلاینت) استفاده می‌شود.</p>
</blockquote>
</li>
<li>
<p><strong>آرگومان content_type:</strong> نوع محتوای فایل را مشخص می‌کند که اینجا به عنوان یک فایل اکسل تنظیم شده است.</p>
<blockquote>
<p><span class="rtl-text">نوع محتوای و داده را مشخص میکند. / به صورت زیر نشان داده میشود. با مثال</span></p>
<p><span class="en-text">type/subtype(format) =&gt; image/jpg</span></p>
</blockquote>
</li>
</ul>
<p>برای متغیر <strong>response</strong> باید مقدار هدر <strong>Content-Disposition</strong> را تغییر دهیم.</p>
<ul>
<li>
<p><strong>Content-Disposition:</strong> به مرورگر می‌گوید که پاسخ باید به صورت یک فایل ضمیمه با نام "orders.xlsx" باشد (نه به عنوان محتوای یک صفحه وب).</p>
<blockquote>
<p><strong>Content-Disposition:</strong> هدر HTTP که مشخص می‌کند چگونه محتوای پاسخ باید پردازش شود، مثلاً به عنوان یک فایل قابل دانلود.</p>
<p><strong>attachment:</strong> مشخص میکند که که پاسخ ما باید به عنوان یک فایل ضمیمه برای دانلود باشد.</p>
<p><strong>filename:</strong> اسم فایل خروجی به همراه پسوند آن میباشد.</p>
</blockquote>
</li>
</ul>
<p><strong><em>خب حالا بریم سراغ ساخت فایل اکسل:</em></strong></p>
<p>3- <strong>ایجاد فایل Excel با OpenPyXL</strong>:</p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">wb</span> <span class="o">=</span> <span class="n">openpyxl</span><span class="o">.</span><span class="n">Workbook</span><span class="p">()</span>
<span class="n">ws</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="n">active</span>
<span class="n">ws</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Orders&#39;</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<ul>
<li>
<p><span class="rtl-text"><code>openpyxl.Workbook()</code>: Workbook درواقع یک فایل اکسل میباشد که میتوانیم چند sheet برایش مشخص کنیم. / پس با این دستور یک فایل اکسل ایجاد میکنیم.</span></p>
</li>
<li>
<p><span class="rtl-text"><code>wb.active</code>: برگه (Sheet) فعال در فایل اکسل را می‌گیرد.</span></p>
</li>
<li>
<p><span class="rtl-text"><code>ws.title = 'Orders'</code>: عنوان برگه اکسل را به "Orders" تغییر می‌دهد.</span></p>
<blockquote>
<p>اتریبیوت title عنوان sheet فعال را تغییر میدهد.</p>
</blockquote>
</li>
</ul>
<p>4- <strong>ایجاد و افزودن عنوان ستون‌ها</strong>:</p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="s1">&#39;First Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Last Name&#39;</span><span class="p">,</span> <span class="s1">&#39;Phone&#39;</span><span class="p">,</span> <span class="s1">&#39;Address&#39;</span><span class="p">,</span> <span class="s1">&#39;Postal Code&#39;</span><span class="p">,</span> <span class="s1">&#39;City&#39;</span><span class="p">,</span> <span class="s1">&#39;Province&#39;</span><span class="p">,</span> <span class="s1">&#39;Paid&#39;</span><span class="p">,</span> <span class="s1">&#39;Created&#39;</span><span class="p">]</span>
<span class="n">ws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">columns</span><span class="p">)</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<ul>
<li>
<p>اسم ستون هایی که قراره در اکسل نمایش داده شوند را در یک لیست مشخص میکنیم.</p>
</li>
<li>
<p>با متد append این لیست را به sheet فعال در فایل اکسل اضافه میکنیم.</p>
</li>
</ul>
<p>5- <strong>افزودن داده‌های سفارشات به اکسل</strong>:</p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="k">for</span> <span class="n">order</span> <span class="ow">in</span> <span class="n">queryset</span><span class="p">:</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">order</span><span class="o">.</span><span class="n">created</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">created</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>

    <span class="n">row</span> <span class="o">=</span> <span class="p">[</span><span class="n">order</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">firstname</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">lastname</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">phone</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">postal_code</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">city</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">province</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">paid</span><span class="p">,</span> <span class="n">created</span><span class="p">]</span>

    <span class="n">ws</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<ul>
<li>
<p><strong>نکته:</strong> نمیشه منطقه زمانی را در اکسل ذخیره کرد(ارور میدهد)؛ بنابراین باید منطقه زمانی(time zone)، را از تاریخ حذف کنیم.</p>
<blockquote>
<p>برای این کار، برای هر سفارش تاریخ ایجاد را صدا زده و tzinfo (مخفف timezone info) را None میکنیم./ برای احتیاط شرط میگذاریم که اگر تاریخ وجود داشت؛ منطقه زمانی را پاک کن تا ارور ندهد.</p>
</blockquote>
</li>
<li>
<p>در حلقه for باید هر بار، برای ستون هایی که ایجاد کردیم به همان ترتیب، مقادیر را از سفارش دریافت کرده و آنها را به عنوان یک ردیف به اکسل اضافه کنیم.</p>
<blockquote>
<p>برای تاریخ ایجاد از متغیری که ایجاد کردیم استفاده میکنیم. / تا منطقه زمانی نداشته باشد.</p>
</blockquote>
</li>
</ul>
<p>6- <strong>ذخیره کردن فایل اکسل در پاسخ</strong>:</p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="n">wb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
<span class="k">return</span> <span class="n">response</span>
</pre></div>

<p><strong>توضیحات:</strong></p>
<ul>
<li>
<p><span class="rtl-text"><code>wb.save(response)</code>: فایل اکسل در شیء پاسخ HTTP ذخیره می‌شود.</span></p>
<blockquote>
<p>بعد از حلقه for  با استفاده از متد save، اطلاعات را ذخیره میکنیم؛ برای اینکه این فایل اکسل در متغیر response ذخیره شود، داخل پرانتزهای متد save عبارت response را مینویسیم.</p>
</blockquote>
</li>
<li>
<p><span class="rtl-text"><code>return response</code>: پاسخ به کاربر بازگردانده می‌شود که باعث دانلود فایل اکسل خواهد شد.</span></p>
</li>
</ul>
<p>7- در نهایت میتوانیم برای اکشن یک اسم دلخواه  مستعار مشخص نیم تا در پنل ادمین نمایش داده شود.</p>
<p><strong>معرفی اکشن به مدل ادمین Order:</strong></p>
<p><code>app directory(orders)/admin.py</code></p>
<div class="code-box">
        <div class="code-info">
            <button class="copy-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" class="icon-sm"><path fill="currentColor" fill-rule="evenodd" d="M7 5a3 3 0 0 1 3-3h9a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3h-2v2a3 3 0 0 1-3 3H5a3 3 0 0 1-3-3v-9a3 3 0 0 1 3-3h2zm2 2h5a3 3 0 0 1 3 3v5h2a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1h-9a1 1 0 0 0-1 1zM5 9a1 1 0 0 0-1 1v9a1 1 0 0 0 1 1h9a1 1 0 0 0 1-1v-9a1 1 0 0 0-1-1z" clip-rule="evenodd"></path></svg>
                <span>Copy code</span>
            </button>
            <span class="language">python</span>
        </div>
    <pre><span></span><span class="nd">@admin</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">Order</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">OrderAdmin</span><span class="p">(</span><span class="n">admin</span><span class="o">.</span><span class="n">ModelAdmin</span><span class="p">):</span>
    <span class="n">list_display</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;buyer&#39;</span><span class="p">,</span> <span class="s1">&#39;firstname&#39;</span><span class="p">,</span> <span class="s1">&#39;lastname&#39;</span><span class="p">,</span> <span class="s1">&#39;phone&#39;</span><span class="p">,</span> <span class="s1">&#39;province&#39;</span><span class="p">,</span> <span class="s1">&#39;city&#39;</span><span class="p">,</span> <span class="s1">&#39;paid&#39;</span><span class="p">)</span>
    <span class="n">list_filter</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;paid&#39;</span><span class="p">,</span> <span class="s1">&#39;created&#39;</span><span class="p">,</span> <span class="s1">&#39;update&#39;</span><span class="p">)</span>
    <span class="n">list_display_links</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;firstname&#39;</span><span class="p">]</span>
    <span class="n">inlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">OrdersItemInline</span><span class="p">]</span>
    <span class="c1"># معرفی اکشن به مدل ادمین:</span>
    <span class="n">actions</span> <span class="o">=</span> <span class="p">[</span><span class="n">export_to_excel</span><span class="p">]</span>
</pre></div>

<hr>

<h4>اصطلاحات کلیدی:</h4>
<p>میخواهیم در مورد "HttpResponse", "content_type", و "MIME-type" یکسری توضیحات اضافه تر بیان کنیم.(جهت درک بیشتر)</p>
<p><strong>1- HttpResponse</strong></p>
<p><strong>توضیح:</strong></p>
<p><strong>HttpResponse:</strong> یک کلاس در فریمورک جنگو است که برای ارسال پاسخ HTTP از سمت سرور به کلاینت استفاده می‌شود. این کلاس به شما اجازه می‌دهد تا محتوای پاسخ، هدرها، و کد وضعیت HTTP را تنظیم کنید.</p>
<blockquote>
<p>به عبارتی، هر زمان که یک درخواست به سرور ارسال می‌شود، سرور باید پاسخی را برگرداند. این پاسخ می‌تواند یک صفحه HTML، یک فایل، یا هر نوع داده دیگری باشد.</p>
</blockquote>
<p><strong>2- content_type</strong></p>
<p><strong>توضیح:</strong></p>
<p><strong>content_type</strong> یک ویژگی از شیء <strong>HttpResponse</strong> است که نوع محتوای داده‌ای که در پاسخ ارسال می‌شود را مشخص می‌کند. این نوع محتوا با استفاده از MIME-type مشخص می‌شود و به مرورگر می‌گوید که چگونه باید داده‌های دریافت‌شده را پردازش کند.</p>
<p><strong>3- MIME-type</strong></p>
<p><strong>توضیح:</strong></p>
<p>MIME-type (Multipurpose Internet Mail Extensions) نوعی استاندارد برای مشخص کردن نوع محتوای داده‌ها در اینترنت است. این نوع اطلاعات به مرورگر یا سایر برنامه‌ها کمک می‌کند تا بدانند چگونه داده‌ها را پردازش کنند و آنرا نمایش دهند.</p>
<p><span class="rtl-text"><strong>فرمت استاندارد MIME به شکل <code>type/subtype</code> است و هر بخش آن توضیح‌دهنده‌ی نوع و زیرنوع محتوای داده‌هاست.</strong></span></p>
<ul>
<li>
<p><strong>type</strong> (نوع): دسته‌بندی کلی محتوا را مشخص می‌کند، مانند "text"، "image"، "application"، "audio"، "video" و غیره.</p>
</li>
<li>
<p><strong>subtype</strong> (زیرنوع): نوع خاص‌تری از محتوا را در آن دسته‌بندی مشخص می‌کند. برای مثال، در دسته‌بندی "text"، زیرنوع می‌تواند "html"، "plain" و ... باشد.</p>
</li>
</ul>
<p>بریم توی یک مثال بهتر این مفاهیم را درک کنیم.</p>
<p>در مثال <strong>text/plain</strong>:</p>
<ul>
<li>
<p><span class="rtl-text"><strong>type</strong>: <code>text</code></span></p>
</li>
<li>
<p><span class="rtl-text"><strong>subtype</strong>: <code>plain</code></span></p>
</li>
<li>
<p><strong>کاربرد</strong>: برای ارسال متن ساده بدون قالب‌بندی.</p>
</li>
</ul>
<p><strong>سایر مثال‌ها:</strong></p>
<ul>
<li>
<p><strong>text/plain:</strong> برای فایل‌های متنی ساده</p>
</li>
<li>
<p><strong>image/jpeg:</strong> برای تصاویر JPEG</p>
</li>
<li>
<p><strong>application/json:</strong> برای داده‌های JSON</p>
</li>
<li>
<p><strong>application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:</strong> برای فایل‌های اکسل (xlsx)</p>
</li>
</ul>
<p><strong><em>جمع‌ بندی:</em></strong></p>
<ul>
<li>
<p><strong>HttpResponse</strong>: کلاس پاسخ‌دهی در جنگو برای ارسال داده‌ها به کاربر.</p>
</li>
<li>
<p><strong>content_type</strong>: نوع محتوای ارسالی در پاسخ که نحوه‌ی پردازش آن را برای مرورگر مشخص می‌کند.</p>
</li>
<li>
<p><strong>MIME-type</strong>: استانداردی برای تعیین نوع داده‌ها که به مرورگر کمک می‌کند تا داده‌ها را به درستی نمایش یا پردازش کند. </p>
</li>
</ul>
<h3 id="tmrynt-fsl-11-mhm">تمرینات فصل 11 (مهم)</h3>
            <a href="https://github.com/virapy/django-booklet/edit/seasons-source/season-11.md" target="_blank" class="edit-icon">
                <i class="fa-solid fa-pen-to-square"></i>
            </a>
        </div>
    </div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script src="https://virapy.github.io/assets/JS/Django-seasons.js"></script>
<script src="https://virapy.github.io/assets/JS/copy-icon.js"></script>
<script src="https://virapy.github.io/assets/JS/Footer-Copyright.js"></script>
</body>
</html>
    